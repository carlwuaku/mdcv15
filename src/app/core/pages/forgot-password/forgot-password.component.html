<div class="forgot-password-container">
  <mat-card class="forgot-password-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>lock_reset</mat-icon>
        Reset Password
      </mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="currentStep === 'username'">Enter your username to receive a reset token</span>
        <span *ngIf="currentStep === 'password'"> Enter the 6-digit token sent to your email and create your new
          password</span>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Step 1: Username Input -->
      <div *ngIf="currentStep === 'username'" class="step-container">
        <form [formGroup]="usernameForm" (ngSubmit)="onSubmitUsername()">
          <mat-form-field appearance="fill" class="full-width">
            <mat-label>Username or Email</mat-label>
            <input matInput formControlName="username" placeholder="Enter your username or email"
              autocomplete="username">
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="usernameError">{{ usernameError }}</mat-error>
          </mat-form-field>

          <div class="button-container">
            <button mat-raised-button color="primary" type="submit" [disabled]="isSubmittingUsername"
              class="full-width">
              <mat-spinner *ngIf="isSubmittingUsername" diameter="20"></mat-spinner>
              <span *ngIf="!isSubmittingUsername">Send Reset Token</span>
              <span *ngIf="isSubmittingUsername">Sending...</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Step 2: Token Input -->
      <!-- <div *ngIf="currentStep === 'token'" class="step-container">
        <div class="info-section">
          <mat-icon class="info-icon">info</mat-icon>
          <p>We've sent a 6-digit token to the email associated with <strong>{{ submittedUsername }}</strong></p>
          <div *ngIf="timeRemaining > 0" class="timer">
            <mat-icon>schedule</mat-icon>
            <span>Token expires in: {{ timerDisplay }}</span>
          </div>
          <div *ngIf="timeRemaining <= 0" class="timer expired">
            <mat-icon>error</mat-icon>
            <span>Token has expired</span>
          </div>
        </div>

        <form [formGroup]="tokenForm" (ngSubmit)="onSubmitToken()">


          <div class="button-container">
            <button mat-raised-button color="primary" type="submit" [disabled]="isSubmittingToken || timeRemaining <= 0"
              class="full-width">
              <mat-spinner *ngIf="isSubmittingToken" diameter="20"></mat-spinner>
              <span *ngIf="!isSubmittingToken">Verify Token</span>
              <span *ngIf="isSubmittingToken">Verifying...</span>
            </button>

            <button mat-stroked-button type="button" (click)="onResendToken()" [disabled]="isSubmittingUsername"
              class="full-width resend-button">
              <mat-spinner *ngIf="isSubmittingUsername" diameter="20"></mat-spinner>
              <span *ngIf="!isSubmittingUsername">Resend Token</span>
              <span *ngIf="isSubmittingUsername">Sending...</span>
            </button>

            <button mat-button type="button" (click)="goBack()" class="full-width back-button">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
          </div>
        </form>
      </div> -->

      <!-- Step 3: New Password Input -->
      <div *ngIf="currentStep === 'password'" class="step-container">
        <div class="info-section">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <p>We've sent a 6-digit token to the email associated with <strong>{{ submittedUsername }}</strong>
            <br>
            Enter the code below and set your new password
          </p>
          <div *ngIf="timeRemaining > 0" class="timer">
            <mat-icon>schedule</mat-icon>
            <span>Token expires in: {{ timerDisplay }}</span>
          </div>
          <div *ngIf="timeRemaining <= 0" class="timer expired">
            <mat-icon>error</mat-icon>
            <span>Token has expired</span>
          </div>
        </div>

        <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()">
          <mat-form-field appearance="fill" class="full-width token-input">
            <mat-label>6-Digit Token</mat-label>
            <input matInput formControlName="token" placeholder="000000" maxlength="6" (input)="onTokenInput($event)"
              autocomplete="one-time-code" class="token-field">
            <mat-icon matPrefix>security</mat-icon>
            <mat-error *ngIf="tokenError">{{ tokenError }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="fill" class="full-width">
            <mat-label>New Password</mat-label>
            <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="newPassword"
              placeholder="Enter your new password" autocomplete="new-password">
            <mat-icon matPrefix>lock</mat-icon>
            <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword"
              [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hidePassword">
              <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="passwordError">{{ passwordError }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="fill" class="full-width">
            <mat-label>Confirm New Password</mat-label>
            <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword"
              placeholder="Confirm your new password" autocomplete="new-password">
            <mat-icon matPrefix>lock</mat-icon>
            <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword"
              [attr.aria-label]="'Hide password'" [attr.aria-pressed]="hideConfirmPassword">
              <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <mat-error *ngIf="confirmPasswordError">{{ confirmPasswordError }}</mat-error>
          </mat-form-field>

          <div class="password-requirements">
            <h4>Password Requirements:</h4>
            <ul>
              <li>At least 8 characters long</li>
              <li>Contains uppercase and lowercase letters</li>
              <li>Contains at least one number</li>
              <li>Contains at least one special character (&#64;$!%*?&)</li>
            </ul>
          </div>

          <div class="button-container">
            <button mat-raised-button color="primary" type="submit" [disabled]="isSubmittingPassword"
              class="full-width">
              <mat-spinner *ngIf="isSubmittingPassword" diameter="20"></mat-spinner>
              <span *ngIf="!isSubmittingPassword">Reset Password</span>
              <span *ngIf="isSubmittingPassword">Resetting...</span>
            </button>
            <button mat-stroked-button type="button" (click)="onResendToken()" [disabled]="isSubmittingUsername"
              class="full-width resend-button">
              <mat-spinner *ngIf="isSubmittingUsername" diameter="20"></mat-spinner>
              <span *ngIf="!isSubmittingUsername">Resend Token</span>
              <span *ngIf="isSubmittingUsername">Sending...</span>
            </button>
            <button mat-button type="button" (click)="goBack()" class="full-width back-button">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
          </div>
        </form>
      </div>
    </mat-card-content>

    <!-- Navigation Footer -->
    <mat-card-actions class="card-actions">
      <div class="step-indicator">
        <span class="step" [class.active]="currentStep === 'username'"
          [class.completed]="currentStep !== 'username'">1</span>
        <span class="step-line" [class.active]="currentStep !== 'username'"></span>

        <span class="step-line" [class.active]="currentStep === 'password'"></span>
        <span class="step" [class.active]="currentStep === 'password'">3</span>
      </div>

      <div class="back-to-login">
        <a mat-button routerLink="/login" color="primary">
          <mat-icon>arrow_back</mat-icon>
          Back to Login
        </a>
      </div>
    </mat-card-actions>
  </mat-card>
</div>
