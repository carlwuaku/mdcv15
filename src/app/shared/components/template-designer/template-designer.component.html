<div class="flex h-max bg-gray-100 w-full" [class.select-none]="isDragging || isResizing">
  <!-- Toolbar -->
  <div class="w-16 bg-gray-800 text-white flex flex-col items-center py-4 space-y-4 select-none">
    <button type="button" (click)="setTool('select')"
      [class]="'p-2 rounded ' + (tool === 'select' ? 'bg-blue-600' : 'hover:bg-gray-700')" title="Select">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M13 6v5h5l-6 6-6-6h5V6z" />
      </svg>
    </button>
    <button type="button" (click)="addElement('text')" class="p-2 rounded hover:bg-gray-700" title="Add Text">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M5 4v3h5.5v12h3V7H19V4z" />
      </svg>
    </button>
    <button type="button" (click)="setTool('rect')"
      [class]="'p-2 rounded ' + (tool === 'rect' ? 'bg-blue-600' : 'hover:bg-gray-700')" title="Add Rectangle">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" />
      </svg>
    </button>
    <button type="button" (click)="setTool('image')"
      [class]="'p-2 rounded ' + (tool === 'image' ? 'bg-blue-600' : 'hover:bg-gray-700')" title="Add Image">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" />
        <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" />
        <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" fill="none" />
      </svg>
    </button>

    <div class="h-px bg-gray-600 w-8"></div>

    <button type="button" (click)="showGrid = !showGrid"
      [class]="'p-2 rounded ' + (showGrid ? 'bg-blue-600' : 'hover:bg-gray-700')" title="Toggle Grid">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" fill="none" stroke="currentColor"
          stroke-width="2" />
      </svg>
    </button>
    <button type="button" (click)="snapToGrid = !snapToGrid"
      [class]="'p-2 rounded ' + (snapToGrid ? 'bg-blue-600' : 'hover:bg-gray-700')" title="Toggle Snap to Grid">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6 12l-3-3 3-3m6 6l3-3-3-3M9 21V3" />
      </svg>
    </button>

    <div class="h-px bg-gray-600 w-8"></div>

    <button type="button" (click)="duplicateElement()" [disabled]="!selectedElement"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Duplicate">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" />
        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" fill="none" stroke="currentColor"
          stroke-width="2" />
      </svg>
    </button>
    <button type="button" (click)="deleteElement()" [disabled]="!selectedElement"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Delete">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" fill="none"
          stroke="currentColor" stroke-width="2" />
      </svg>
    </button>
    <div class="h-px bg-gray-600 w-8"></div>

    <!-- Layer Controls in Toolbar -->
    <button type="button" (click)="bringToFront()" [disabled]="!selectedElement || !canMoveUp()"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Bring to Front (Ctrl+â†‘)">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
      </svg>
    </button>

    <button type="button" (click)="bringForward()" [disabled]="!selectedElement || !canMoveUp()"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Bring Forward (Ctrl+])">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M7 14l5-5 5 5z" />
      </svg>
    </button>

    <button type="button" (click)="sendBackward()" [disabled]="!selectedElement || !canMoveDown()"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Send Backward (Ctrl+[)">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M17 10l-5 5-5-5z" />
      </svg>
    </button>

    <button type="button" (click)="sendToBack()" [disabled]="!selectedElement || !canMoveDown()"
      class="p-2 rounded hover:bg-gray-700 disabled:opacity-50" title="Send to Back (Ctrl+â†“)">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M8 18l-2.29-2.29 4.88-4.88 4 4L22 7.41 20.59 6l-6 6-4-4-6.3 6.29L2 12v6z" />
      </svg>
    </button>

    <div class="h-px bg-gray-600 w-8"></div>

    <button type="button" (click)="exportTemplate()" class="p-2 rounded hover:bg-gray-700" title="Export Template">
      <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" fill="none" stroke="currentColor"
          stroke-width="2" />
      </svg>
    </button>
  </div>

  <!-- Canvas Area -->
  <div class="flex-1 flex flex-col overflow-auto">
    <!-- Canvas Header -->
    <div class="px-8 py-2 bg-gray-50 border-b border-gray-200">
      <div class="text-sm text-gray-600">
        <span class="font-medium">{{pageSize}}</span> â€¢ {{orientation}} â€¢ {{canvasWidth}} x {{canvasHeight}}px
        <span class="ml-2 text-gray-400" *ngIf="pageSize !== 'Custom'">
          ({{getDimensionsDisplay()}})
        </span>
      </div>
    </div>

    <div class="flex-1 flex items-center justify-center p-8 overflow-auto">
      <div #canvas class="relative bg-white shadow-lg cursor-crosshair" [class.select-none]="isDragging || isResizing"
        [style.width.px]="canvasWidth" [style.height.px]="canvasHeight"
        [style.user-select]="(isDragging || isResizing) ? 'none' : 'auto'" (mousemove)="handleMouseMove($event)"
        (mouseup)="handleMouseUp()" (click)="handleCanvasClick($event)">
        <!-- Grid -->
        <svg *ngIf="showGrid" class="absolute inset-0 pointer-events-none" [attr.width]="canvasWidth"
          [attr.height]="canvasHeight" style="z-index: 1">
          <defs>
            <pattern id="grid" [attr.width]="gridSize" [attr.height]="gridSize" patternUnits="userSpaceOnUse">
              <path [attr.d]="'M ' + gridSize + ' 0 L 0 0 0 ' + gridSize" fill="none" stroke="#e5e7eb"
                stroke-width="0.5" />
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#grid)" />

          <!-- Canvas center lines -->
          <line [attr.x1]="canvasWidth / 2" y1="0" [attr.x2]="canvasWidth / 2" [attr.y2]="canvasHeight" stroke="#d1d5db"
            stroke-width="1" stroke-dasharray="5,5" />
          <line x1="0" [attr.y1]="canvasHeight / 2" [attr.x2]="canvasWidth" [attr.y2]="canvasHeight / 2"
            stroke="#d1d5db" stroke-width="1" stroke-dasharray="5,5" />
        </svg>

        <!-- Alignment Guides -->
        <svg *ngIf="alignmentGuides.vertical.length > 0 || alignmentGuides.horizontal.length > 0"
          class="absolute inset-0 pointer-events-none" [attr.width]="canvasWidth" [attr.height]="canvasHeight"
          style="z-index: 999">
          <!-- Vertical guides -->
          <g *ngFor="let guide of alignmentGuides.vertical; let i = index">
            <line [attr.x1]="guide.x" y1="0" [attr.x2]="guide.x" [attr.y2]="canvasHeight"
              [attr.stroke]="guide.type === 'canvas-center' ? '#ef4444' : '#3b82f6'" stroke-width="2"
              stroke-dasharray="3,3" />
            <text *ngIf="guide.label" [attr.x]="guide.x! + 5" y="20"
              [attr.fill]="guide.type === 'canvas-center' ? '#ef4444' : '#3b82f6'" font-size="12" font-weight="bold">
              {{guide.label}}
            </text>
          </g>

          <!-- Horizontal guides -->
          <g *ngFor="let guide of alignmentGuides.horizontal; let i = index">
            <line x1="0" [attr.y1]="guide.y" [attr.x2]="canvasWidth" [attr.y2]="guide.y"
              [attr.stroke]="guide.type === 'canvas-center' ? '#ef4444' : '#3b82f6'" stroke-width="2"
              stroke-dasharray="3,3" />
            <text *ngIf="guide.label" x="20" [attr.y]="guide.y! - 5"
              [attr.fill]="guide.type === 'canvas-center' ? '#ef4444' : '#3b82f6'" font-size="12" font-weight="bold">
              {{guide.label}}
            </text>
          </g>
        </svg>

        <!-- Elements -->
        <div *ngFor="let element of elements; trackBy: trackElement" class="absolute border-2 cursor-move"
          [class.border-blue-500]="selectedElement === element.id"
          [class.border-dashed]="selectedElement === element.id"
          [class.border-transparent]="selectedElement !== element.id"
          [class.hover:border-gray-300]="selectedElement !== element.id" [style.left.px]="element.x"
          [style.top.px]="element.y" [style.width.px]="element.width" [style.height.px]="element.height"
          [style.transform]="'rotate(' + element.rotation + 'deg)'" [style.z-index]="element.zIndex + 1000"
          (mousedown)="handleMouseDown($event, element.id)">
          <!-- Text Element -->
          <div *ngIf="element.type === 'text'" class="w-full h-full flex select-none"
            [style.font-size.px]="element.fontSize" [style.font-weight]="element.fontWeight"
            [style.font-style]="element.fontStyle" [style.text-decoration]="element.textDecoration"
            [style.color]="element.color" [style.background-color]="element.backgroundColor"
            [style.border]="element.borderWidth > 0 ? element.borderWidth + 'px ' + element.borderStyle + ' ' + element.borderColor : 'none'"
            [style.align-items]="getVerticalAlignment(element.verticalAlign)"
            [style.justify-content]="getHorizontalAlignment(element.textAlign)" [style.text-align]="element.textAlign"
            [style.padding]="'4px'" [style.user-select]="'none'" [style.pointer-events]="'none'">
            <div [style.width]="'100%'" [style.text-align]="element.textAlign">
              {{element.content}}
            </div>
          </div>

          <!-- Rectangle Element -->
          <div *ngIf="element.type === 'rect'" class="w-full h-full select-none"
            [style.background-color]="element.backgroundColor"
            [style.border]="element.borderWidth > 0 ? element.borderWidth + 'px ' + element.borderStyle + ' ' + element.borderColor : 'none'"
            [style.user-select]="'none'" [style.pointer-events]="'none'"></div>

          <!-- Image Element -->
          <div *ngIf="element.type === 'image'"
            class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 relative overflow-hidden select-none"
            [style.border]="element.borderWidth > 0 ? element.borderWidth + 'px ' + element.borderStyle + ' ' + element.borderColor : 'none'"
            [style.user-select]="'none'" [style.pointer-events]="'none'">
            <img *ngIf="element.content; else noImage" [src]="element.content" alt="Template"
              class="w-full h-full object-contain"
              style="max-width: 100%; max-height: 100%; user-select: none; pointer-events: none;" draggable="false" />
            <ng-template #noImage>
              <div class="flex flex-col items-center">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor"
                    stroke-width="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" />
                  <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
                <span class="text-xs mt-1">No Image</span>
              </div>
            </ng-template>
            <div *ngIf="uploadingImage === element.id"
              class="absolute inset-0 bg-blue-500 bg-opacity-20 flex items-center justify-center">
              <div class="text-blue-600 font-medium">Uploading...</div>
            </div>
          </div>

          <!-- Resize Handles -->
          <ng-container *ngIf="selectedElement === element.id">
            <!-- Corner handles -->
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-nw-resize" style="top: -4px; left: -4px"
              (mousedown)="handleResizeMouseDown($event, 'nw')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-ne-resize"
              style="top: -4px; right: -4px" (mousedown)="handleResizeMouseDown($event, 'ne')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-sw-resize"
              style="bottom: -4px; left: -4px" (mousedown)="handleResizeMouseDown($event, 'sw')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-se-resize"
              style="bottom: -4px; right: -4px" (mousedown)="handleResizeMouseDown($event, 'se')"></div>

            <!-- Edge handles -->
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-n-resize"
              style="top: -4px; left: 50%; transform: translateX(-50%)"
              (mousedown)="handleResizeMouseDown($event, 'n')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-s-resize"
              style="bottom: -4px; left: 50%; transform: translateX(-50%)"
              (mousedown)="handleResizeMouseDown($event, 's')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-w-resize"
              style="top: 50%; left: -4px; transform: translateY(-50%)"
              (mousedown)="handleResizeMouseDown($event, 'w')"></div>
            <div class="absolute w-2 h-2 bg-blue-500 border border-white cursor-e-resize"
              style="top: 50%; right: -4px; transform: translateY(-50%)"
              (mousedown)="handleResizeMouseDown($event, 'e')"></div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- Properties Panel -->
  <div class="min-w-80 bg-white border-l border-gray-300 p-4 overflow-y-auto max-h-[90vh]">
    <h3 class="text-lg font-semibold mb-4">Properties</h3>

    <!-- Page Settings -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <h4 class="font-medium mb-3">Page Settings</h4>
      <div class="space-y-3">
        <div class="flex flex-col gap-1">
          <label class="block text-sm mb-1">Page Size</label>
          <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()"
            class="w-full px-2 py-1 border rounded text-sm">
            <option value="A4">A4 (297x210mm)</option>
            <option value="A3">A3 (420x297mm)</option>
            <option value="A5">A5 (210x148mm)</option>
            <option value="Letter">Letter (11x8.5")</option>
            <option value="Legal">Legal (14x8.5")</option>
            <option value="Tabloid">Tabloid (17x11")</option>
            <option value="Custom">Custom</option>
          </select>
          <div class="flex gap-1" *ngIf="pageSize === 'Custom'">
            <input type="number" #customPageWidth class="w-1/2 px-2 py-1 border rounded text-sm" placeholder="Width">
            <input type="number" #customPageHeight class="w-1/2 px-2 py-1 border rounded text-sm" placeholder="Height">
            <button type="button" (click)="onCustomPageSizeChange(customPageWidth.value, customPageHeight.value)"
              class="px-3 py-2 text-sm rounded border bg-blue-500 text-white border-blue-500 hover:border-blue-600">
              Set
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Orientation</label>
          <div class="flex space-x-2">
            <button type="button" (click)="setOrientation('landscape')"
              [class]="'flex-1 px-3 py-2 text-sm rounded border ' + (orientation === 'landscape' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:border-gray-400')">
              ðŸ“„ Landscape
            </button>
            <button type="button" (click)="setOrientation('portrait')"
              [class]="'flex-1 px-3 py-2 text-sm rounded border ' + (orientation === 'portrait' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:border-gray-400')">
              ðŸ“‹ Portrait
            </button>
          </div>
        </div>
        <div class="text-xs text-gray-500">
          Canvas: {{canvasWidth}} x {{canvasHeight}}px
        </div>
      </div>
    </div>

    <!-- Grid Settings -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <h4 class="font-medium mb-3">Grid & Alignment</h4>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <label class="text-sm">Show Grid</label>
          <button type="button" (click)="showGrid = !showGrid"
            [class]="'px-3 py-1 rounded text-sm ' + (showGrid ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700')">
            {{showGrid ? 'On' : 'Off'}}
          </button>
        </div>
        <div class="flex items-center justify-between">
          <label class="text-sm">Snap to Grid</label>
          <button type="button" (click)="snapToGrid = !snapToGrid"
            [class]="'px-3 py-1 rounded text-sm ' + (snapToGrid ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700')">
            {{snapToGrid ? 'On' : 'Off'}}
          </button>
        </div>
        <div>
          <label class="block text-sm mb-1">Grid Size: {{gridSize}}px</label>
          <input type="range" min="5" max="50" [(ngModel)]="gridSize" class="w-full" />
        </div>
        <div>
          <label class="block text-sm mb-1">Arrow Key Step: {{keyboardStep}}px</label>
          <input type="range" min="1" max="20" [(ngModel)]="keyboardStep" class="w-full" />
          <div class="text-xs text-gray-500 mt-1">
            Tip: Hold Shift for grid steps, Ctrl/Cmd for 0.5px steps
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="selectedEl" class="space-y-4">
      <!-- Keyboard shortcuts info -->
      <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
        <h5 class="text-sm font-medium text-blue-800 mb-2">Keyboard Shortcuts</h5>
        <div class="text-xs text-blue-700 space-y-1">
          <div>â€¢ Arrow keys: Move element</div>
          <div>â€¢ Shift + Arrow: Move by grid size</div>
          <div>â€¢ Ctrl/Cmd + Arrow: Fine movement (0.5px)</div>
          <div>â€¢ Delete/Backspace: Delete element</div>
          <div>â€¢ Escape: Deselect element</div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Position</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="text" [(ngModel)]="selectedEl.x" (ngModelChange)="updateSelectedElement({x: selectedEl.x})"
            class="px-2 py-1 border rounded text-sm" placeholder="X" />
          <input type="text" [(ngModel)]="selectedEl.y" (ngModelChange)="updateSelectedElement({y: selectedEl.y})"
            class="px-2 py-1 border rounded text-sm" placeholder="Y" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Size</label>
        <div class="grid grid-cols-2 gap-2">
          <input type="text" [(ngModel)]="selectedEl.width"
            (ngModelChange)="updateSelectedElement({width: selectedEl.width})" class="px-2 py-1 border rounded text-sm"
            placeholder="Width" />
          <input type="text" [(ngModel)]="selectedEl.height"
            (ngModelChange)="updateSelectedElement({height: selectedEl.height})"
            class="px-2 py-1 border rounded text-sm" placeholder="Height" />
        </div>
      </div>

      <!-- Text Properties -->
      <ng-container *ngIf="selectedEl.type === 'text'">
        <div>
          <label class="block text-sm font-medium mb-1">Content</label>
          <textarea [(ngModel)]="selectedEl.content"
            (ngModelChange)="updateSelectedElement({content: selectedEl.content})"
            class="w-full px-2 py-1 border rounded text-sm" rows="3"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Font Size</label>
          <input type="number" [(ngModel)]="selectedEl.fontSize"
            (ngModelChange)="updateSelectedElement({fontSize: selectedEl.fontSize})"
            class="w-full px-2 py-1 border rounded text-sm" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Text Style</label>
          <div class="flex space-x-2">
            <button type="button" (click)="toggleTextStyle('fontWeight', 'bold', 'normal')"
              [class]="' w-[30px] p-1 border rounded ' + (selectedEl.fontWeight === 'bold' ? 'bg-blue-100' : '')">
              <strong>B</strong>
            </button>
            <button type="button" (click)="toggleTextStyle('fontStyle', 'italic', 'normal')"
              [class]="'w-[30px] p-1 border rounded ' + (selectedEl.fontStyle === 'italic' ? 'bg-blue-100' : '')">
              <em>I</em>
            </button>
            <button type="button" (click)="toggleTextStyle('textDecoration', 'underline', 'none')"
              [class]="'w-[30px] p-1 border rounded ' + (selectedEl.textDecoration === 'underline' ? 'bg-blue-100' : '')">
              <u>U</u>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Text Align</label>
          <div class="flex space-x-2">
            <button type="button" *ngFor="let align of ['left', 'center', 'right']"
              (click)="updateSelectedElement({textAlign: align})"
              [class]="'w-[30px] p-1 border rounded ' + (selectedEl.textAlign === align ? 'bg-blue-100' : '')">
              {{align[0].toUpperCase()}}
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Vertical Align</label>
          <div class="flex space-x-2">
            <button type="button" *ngFor="let align of ['top', 'middle', 'bottom']"
              (click)="updateSelectedElement({verticalAlign: align})"
              [class]="'w-[30px] p-1 border rounded ' + (selectedEl.verticalAlign === align ? 'bg-blue-100' : '')">
              {{align[0].toUpperCase()}}
            </button>
          </div>
        </div>
      </ng-container>

      <!-- Image Properties -->
      <ng-container *ngIf="selectedEl.type === 'image'">
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-2">Image Source</label>
            <div class="space-y-2">
              <button type="button" (click)="triggerImageUpload()" [disabled]="uploadingImage === selectedEl.id"
                class="w-full px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-blue-300 flex items-center justify-center space-x-2">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" fill="none"
                    stroke="currentColor" stroke-width="2" />
                </svg>
                <span>{{uploadingImage === selectedEl.id ? 'Uploading...' : 'Upload Image'}}</span>
              </button>

              <div class="text-xs text-gray-500 text-center">
                Supports: JPG, PNG, GIF, WebP (Max 10MB)
              </div>

              <div *ngIf="selectedEl.content" class="mt-3">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-sm text-gray-600">Preview:</label>
                  <button type="button" (click)="updateSelectedElement({content: ''})"
                    class="text-xs text-red-500 hover:text-red-700">
                    Remove
                  </button>
                </div>
                <div class="w-full h-24 bg-gray-100 rounded border flex items-center justify-center overflow-hidden">
                  <img [src]="selectedEl.content" alt="Preview" class="max-w-full max-h-full object-contain" />
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  Size: {{getImageSize(selectedEl.content)}}KB
                </div>
              </div>
            </div>
          </div>

          <div class="border-t pt-3">
            <label class="block text-sm font-medium mb-1">Or Enter Image URL</label>
            <input type="text"
              [value]="selectedEl.content && !selectedEl.content.startsWith('data:') ? selectedEl.content : ''"
              (input)="updateSelectedElement({content: $any($event.target).value})"
              class="w-full px-2 py-1 border rounded text-sm" placeholder="https://example.com/image.jpg" />
          </div>
        </div>
      </ng-container>
      <!-- Color Properties -->
      <div>
        <label class="block text-sm font-medium mb-2">Colors</label>
        <div class="space-y-4">

          <!-- Text/Stroke Color -->
          <div>
            <label class="block text-xs text-gray-600 mb-2">Text/Stroke Color</label>
            <div class="flex space-x-2">
              <input type="color" [(ngModel)]="selectedEl.color"
                (ngModelChange)="updateSelectedElement({color: selectedEl.color})"
                class="w-12 h-8 border rounded cursor-pointer" />
              <input type="text" [(ngModel)]="selectedEl.color"
                (ngModelChange)="updateSelectedElement({color: selectedEl.color})"
                class="flex-1 px-2 py-1 border rounded text-sm" placeholder="#000000" />
            </div>
          </div>

          <!-- Fill/Background Color -->
          <div>
            <label class="block text-xs text-gray-600 mb-2">Fill/Background Color</label>

            <!-- Color Picker and Input -->
            <div class="flex space-x-2 mb-2">
              <input type="color" [value]="getBaseFillColor()"
                (input)="updateFillColor($any($event.target).value, getCurrentOpacity())"
                class="w-12 h-8 border rounded cursor-pointer"
                [disabled]="isTransparentColor(selectedEl.backgroundColor)" />
              <input type="text" [(ngModel)]="selectedEl.backgroundColor"
                (ngModelChange)="updateSelectedElement({backgroundColor: selectedEl.backgroundColor})"
                class="flex-1 px-2 py-1 border rounded text-sm" placeholder="transparent" />
              <button type="button" (click)="setTransparentFill()"
                class="px-3 py-1 text-xs border rounded hover:bg-gray-100" title="Set Transparent">
                âˆ…
              </button>
            </div>

            <!-- Opacity Control -->
            <div *ngIf="!isTransparentColor(selectedEl.backgroundColor)" class="mb-2">
              <label class="block text-xs text-gray-600 mb-1">
                Opacity: {{Math.round(getCurrentOpacity() * 100)}}%
              </label>
              <input type="range" min="0" max="1" step="0.1" [value]="getCurrentOpacity()"
                (input)="updateFillColor(getBaseFillColor(), parseFloat($any($event.target).value))" class="w-full" />
            </div>

            <!-- Color Presets -->
            <div>
              <label class="block text-xs text-gray-600 mb-1">Quick Colors</label>
              <div class="grid grid-cols-6 gap-1">
                <button type="button" *ngFor="let preset of getFillColorPresets()"
                  (click)="updateFillColor(preset.color)"
                  class="w-8 h-6 border border-gray-300 rounded cursor-pointer hover:scale-110 transition-transform"
                  [style.background-color]="preset.color === 'transparent' ? 'white' : preset.color"
                  [class.border-2]="selectedEl.backgroundColor === preset.color"
                  [class.border-blue-500]="selectedEl.backgroundColor === preset.color" [title]="preset.label">
                  <span *ngIf="preset.color === 'transparent'" class="text-xs text-gray-400">âˆ…</span>
                </button>
              </div>
            </div>

            <!-- Fill Preview -->
            <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
              <strong>Preview:</strong> {{getFillPreview()}}
            </div>

            <!-- Element-Specific Fill Options -->
            <div *ngIf="selectedEl.type === 'rect'" class="mt-2">
              <label class="block text-xs text-gray-600 mb-1">Shape Presets</label>
              <div class="grid grid-cols-2 gap-1">
                <button
                  (click)="updateSelectedElement({backgroundColor: 'transparent', borderWidth: 2, borderStyle: 'solid', borderColor: '#000000'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  Outline Only
                </button>
                <button
                  (click)="updateSelectedElement({backgroundColor: '#FFFFFF', borderWidth: 1, borderStyle: 'solid', borderColor: '#000000'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  White Fill
                </button>
                <button
                  (click)="updateSelectedElement({backgroundColor: '#F3F4F6', borderWidth: 0, borderStyle: 'none'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  Gray Fill
                </button>
                <button
                  (click)="updateSelectedElement({backgroundColor: '#3B82F6', borderWidth: 0, borderStyle: 'none'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  Blue Fill
                </button>
              </div>
            </div>

            <div *ngIf="selectedEl.type === 'text'" class="mt-2">
              <label class="block text-xs text-gray-600 mb-1">Text Background Presets</label>
              <div class="grid grid-cols-2 gap-1">
                <button type="button" (click)="updateSelectedElement({backgroundColor: 'transparent'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  No Background
                </button>
                <button type="button" (click)="updateFillColor('#FFFFFF', 0.9)"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  White Highlight
                </button>
                <button type="button" (click)="updateFillColor('#FFFF00', 0.3)"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  Yellow Highlight
                </button>
                <button type="button" (click)="updateSelectedElement({backgroundColor: '#000000', color: '#FFFFFF'})"
                  class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                  Reverse Text
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Border Properties -->
      <div>
        <label class="block text-sm font-medium mb-2">Border</label>
        <div class="space-y-3">
          <!-- Border Style -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Style</label>
            <select [(ngModel)]="selectedEl.borderStyle"
              (ngModelChange)="updateSelectedElementBorder('borderStyle', selectedEl.borderStyle)"
              class="w-full px-2 py-1 border rounded text-sm">
              <option *ngFor="let option of getBorderStyleOptions()" [value]="option.value">
                {{option.label}}
              </option>
            </select>
          </div>

          <!-- Border Width -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Width: {{selectedEl.borderWidth}}px</label>
            <div class="flex space-x-2">
              <input type="range" min="0" max="10" [(ngModel)]="selectedEl.borderWidth"
                (ngModelChange)="updateSelectedElementBorder('borderWidth', selectedEl.borderWidth)" class="flex-1" />
              <input type="number" min="0" max="50" [(ngModel)]="selectedEl.borderWidth"
                (ngModelChange)="updateSelectedElementBorder('borderWidth', selectedEl.borderWidth)"
                class="w-16 px-2 py-1 border rounded text-xs" />
            </div>
          </div>

          <!-- Border Color -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Color</label>
            <div class="flex space-x-2">
              <input type="color" [(ngModel)]="selectedEl.borderColor"
                (ngModelChange)="updateSelectedElementBorder('borderColor', selectedEl.borderColor)"
                class="w-12 h-8 border rounded cursor-pointer" />
              <input type="text" [(ngModel)]="selectedEl.borderColor"
                (ngModelChange)="updateSelectedElementBorder('borderColor', selectedEl.borderColor)"
                class="flex-1 px-2 py-1 border rounded text-sm" placeholder="#000000" />
            </div>
          </div>

          <!-- Border Preview -->
          <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
            <strong>Preview:</strong> {{getBorderPreview(selectedEl)}}
          </div>

          <!-- Quick Border Presets -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Quick Presets</label>
            <div class="grid grid-cols-2 gap-1">
              <button type="button" (click)="updateSelectedElement({borderWidth: 0, borderStyle: 'none'})"
                class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                No Border
              </button>
              <button type="button"
                (click)="updateSelectedElement({borderWidth: 1, borderStyle: 'solid', borderColor: '#000000'})"
                class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                Thin Solid
              </button>
              <button type="button"
                (click)="updateSelectedElement({borderWidth: 2, borderStyle: 'dashed', borderColor: '#000000'})"
                class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                Dashed
              </button>
              <button type="button"
                (click)="updateSelectedElement({borderWidth: 3, borderStyle: 'solid', borderColor: '#000000'})"
                class="px-2 py-1 text-xs border rounded hover:bg-gray-100">
                Thick Solid
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- z-index (layering) -->
      <div *ngIf="selectedEl">
        <label class="block text-sm font-medium mb-2">Layer Order</label>
        <div class="space-y-3">

          <!-- Layer Position Info -->
          <div class="p-2 bg-gray-50 rounded text-sm">
            <div class="flex justify-between items-center">
              <span class="text-gray-600">Position:</span>
              <span class="font-medium">{{getElementLayerPosition(selectedEl.id)}} of {{getTotalLayers()}}</span>
            </div>
            <div class="flex justify-between items-center mt-1">
              <span class="text-gray-600">Z-Index:</span>
              <span class="font-medium">{{selectedEl.zIndex}}</span>
            </div>
          </div>

          <!-- Quick Layer Actions -->
          <div class="grid grid-cols-2 gap-2">
            <button type="button" (click)="bringToFront()"
              class="px-3 py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center justify-center space-x-1"
              title="Bring to Front (Ctrl+â†‘)">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
              </svg>
              <span>Front</span>
            </button>
            <button type="button" (click)="sendToBack()"
              class="px-3 py-2 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 flex items-center justify-center space-x-1"
              title="Send to Back (Ctrl+â†“)">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 18l-2.29-2.29 4.88-4.88 4 4L22 7.41 20.59 6l-6 6-4-4-6.3 6.29L2 12v6z" />
              </svg>
              <span>Back</span>
            </button>
          </div>

          <!-- Step Forward/Backward -->
          <div class="grid grid-cols-2 gap-2">
            <button type="button" (click)="bringForward()" [disabled]="!canMoveUp()"
              class="px-3 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-1"
              title="Bring Forward (Ctrl+])">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 14l5-5 5 5z" />
              </svg>
              <span>Forward</span>
            </button>
            <button type="button" (click)="sendBackward()" [disabled]="!canMoveDown()"
              class="px-3 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-1"
              title="Send Backward (Ctrl+[)">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17 10l-5 5-5-5z" />
              </svg>
              <span>Backward</span>
            </button>
          </div>

          <!-- Specific Layer Position -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Move to Layer Position</label>
            <div class="flex space-x-2">
              <select [value]="getElementLayerPosition(selectedEl.id)"
                (change)="moveToLayer(parseInt($any($event.target).value))"
                class="flex-1 px-2 py-1 border rounded text-sm">
                <option *ngFor="let i of Array(getTotalLayers()).fill(0); let idx = index" [value]="idx + 1">
                  Layer {{idx + 1}}{{idx + 1 === getTotalLayers() ? ' (Front)' : idx + 1 === 1 ? ' (Back)' : ''}}
                </option>
              </select>
              <button type="button" (click)="normalizeZIndexes()"
                class="px-2 py-1 text-xs border rounded hover:bg-gray-50" title="Clean up layer order">
                â†»
              </button>
            </div>
          </div>

          <!-- Manual Z-Index -->
          <div>
            <label class="block text-xs text-gray-600 mb-1">Manual Z-Index</label>
            <input type="number" [(ngModel)]="selectedEl.zIndex" (ngModelChange)="setZIndex(selectedEl.zIndex)"
              class="w-full px-2 py-1 border rounded text-sm" placeholder="Z-Index value" />
          </div>

          <!-- Keyboard Shortcuts Help -->
          <div class="p-2 bg-blue-50 rounded text-xs text-blue-700">
            <div class="font-medium mb-1">Layer Shortcuts:</div>
            <div>â€¢ Ctrl+â†‘/â†“: Front/Back</div>
            <div>â€¢ Ctrl+]/[: Forward/Backward</div>
          </div>
        </div>
      </div>

      <!-- Add this Layers Panel as a separate section - can be placed before or after the main properties -->

      <!-- Layers Panel -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h4 class="font-medium mb-3 flex items-center justify-between">
          <span>Layers</span>
          <span class="text-xs text-gray-500">{{elements.length}} elements</span>
        </h4>

        <div class="space-y-1 max-h-40 overflow-y-auto">
          <div *ngFor="let layerInfo of getLayerInfo()" (click)="selectElementFromLayer(layerInfo.element.id)"
            class="flex items-center justify-between p-2 rounded cursor-pointer transition-colors"
            [class.bg-blue-100]="layerInfo.isSelected" [class.border-2]="layerInfo.isSelected"
            [class.border-blue-500]="layerInfo.isSelected" [class.hover:bg-gray-100]="!layerInfo.isSelected">
            <div class="flex items-center space-x-2 flex-1 min-w-0">
              <!-- Element Type Icon -->
              <div class="flex-shrink-0">
                <svg *ngIf="layerInfo.element.type === 'text'" width="16" height="16" fill="currentColor"
                  viewBox="0 0 24 24">
                  <path d="M5 4v3h5.5v12h3V7H19V4z" />
                </svg>
                <svg *ngIf="layerInfo.element.type === 'rect'" width="16" height="16" fill="currentColor"
                  viewBox="0 0 24 24">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor"
                    stroke-width="2" />
                </svg>
                <svg *ngIf="layerInfo.element.type === 'image'" width="16" height="16" fill="currentColor"
                  viewBox="0 0 24 24">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor"
                    stroke-width="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" />
                  <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" fill="none" />
                </svg>
              </div>

              <!-- Element Name -->
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium truncate">
                  {{getElementDisplayName(layerInfo.element)}}
                </div>
                <div class="text-xs text-gray-500">
                  {{layerInfo.element.type}} â€¢ Layer {{layerInfo.position}}
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity"
              *ngIf="layerInfo.isSelected">
              <button type="button" (click)="bringForward(); $event.stopPropagation()" [disabled]="!canMoveUp()"
                class="p-1 hover:bg-gray-200 rounded disabled:opacity-50" title="Move Forward">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7 14l5-5 5 5z" />
                </svg>
              </button>
              <button type="button" (click)="sendBackward(); $event.stopPropagation()" [disabled]="!canMoveDown()"
                class="p-1 hover:bg-gray-200 rounded disabled:opacity-50" title="Move Backward">
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M17 10l-5 5-5-5z" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="elements.length === 0" class="text-center text-gray-500 text-sm py-4">
          No elements yet. Add some elements to manage layers.
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Rotation</label>
        <input type="range" min="-180" max="180" [(ngModel)]="selectedEl.rotation"
          (ngModelChange)="updateSelectedElement({rotation: selectedEl.rotation})" class="w-full" />
        <div class="text-sm text-gray-600 text-center">{{selectedEl.rotation}}Â°</div>
      </div>
    </div>

    <p *ngIf="!selectedEl" class="text-gray-500">Select an element to edit properties</p>
  </div>

  <!-- Hidden file input for image uploads -->
  <input #fileInput type="file" accept="image/*" (change)="handleFileInputChange($event)" class="hidden" />
</div>
